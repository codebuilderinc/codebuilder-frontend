name: 'ğŸš€ Deploy Next.js Docker App (Single Job)'

on:
  push:
    branches: [disabled]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    name: 'ğŸ³ Build & Deploy'
    steps:
      - name: 'ğŸ” Checkout Code'
        uses: actions/checkout@v3

      # ========================
      # ğŸ” Secrets & Config Setup
      # ========================
      - name: 'ğŸ”’ Verify Secrets Exist'
        run: |
          if [ -z "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" ]; then
            echo "âŒ Critical error: GOOGLE_SERVICES_JSON_BASE64 secret missing!"
            exit 1
          fi
          echo "âœ… All secrets present"

      - name: 'ğŸ“ Create google-services.json'
        run: |
          echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 --decode > google-services.json
          echo "ğŸ”„ Validating JSON..."
          jq empty google-services.json  # Requires jq installed
        env:
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}

      - name: 'âš™ï¸ Create .env File'
        run: |
          echo "${{ secrets.ENV_FILE_CONTENT }}" > .env
          echo "" >> .env  # Ensure trailing newline

      # ========================
      # ğŸ³ Docker Operations
      # ========================
      - name: 'ğŸ›  Build Docker Image'
        run: docker build -t codebuilder-webapp:latest .

      - name: 'ğŸ—‘ Cleanup Old Containers'
        run: |
          docker ps -aq --filter name=codebuilder-webapp | xargs -r docker rm -f

      - name: 'ğŸš€ Launch New Container'
        run: |
          docker run -d \
            --network host \
            -p 3000:3000 \
            --env-file .env \
            --name codebuilder-webapp \
            codebuilder-webapp:latest
