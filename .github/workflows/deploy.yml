name: 'ğŸš€ Deploy Next.js Docker App'

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    name: 'ğŸ³ Build & Deploy'
    steps:
      - name: 'ğŸ” Checkout Code'
        uses: actions/checkout@v3

      # ========================
      # ğŸ” Secrets & Config Setup
      # ========================
      - name: 'ğŸ”’ Verify Secrets Exist'
        run: |
          if [ -z "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" ]; then
            echo "âŒ Critical error: GOOGLE_SERVICES_JSON_BASE64 secret missing!"
            exit 1
          fi
          echo "âœ… All secrets present"

      - name: 'ğŸ“ Create google-services.json'
        run: |
          echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 --decode > google-services.json
          echo "ğŸ”„ Validating JSON..."
          jq empty google-services.json  # Requires jq installed
        env:
          GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}

      - name: 'âš™ï¸ Create .env File'
        run: |
          echo "${{ secrets.ENV_FILE_CONTENT }}" > .env
          echo "" >> .env  # Ensure trailing newline

      # =======================================================
      # ğŸ³ Docker Compose Operations (This section is updated)
      # =======================================================
      - name: 'ğŸš€ Launch or Update Services'
        run: |
          docker compose up --build -d
          # 'up' brings all services up.
          # '--build' rebuilds the webapp image if code has changed.
          # '-d' runs the containers in the background (detached mode).
          # Docker Compose automatically stops and replaces only the containers that need updating.

      - name: 'ğŸ—‘ Prune Old Docker Images'
        run: |
          docker image prune -af
          # This is an optional but recommended step to clean up old, unused image layers.
